<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Схема здания с этажами</title>
    <style>
        :root{
          --line:#222; --bg:#f7f7f9; --text:#111;
          --free:#e8f8ef; --free-border:#6ccf96;
          --warn:#fff4cc; --warn-border:#f2c200;
          --danger:#ffe1e1; --danger-border:#ff6b6b;
          --over:#111; --over-text:#fff;
          --hover:#f1f5ff;
        }
        *{box-sizing:border-box}
        body{margin:0;background:var(--bg);color:var(--text);font:14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
        .wrap{width:min(1200px,96vw);margin:0 auto;padding:28px 12px 48px}
        h1{margin:0 0 6px;font-size:20px}
        p.lead{margin:0 0 14px;color:#555}

        .toolbar{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:12px}
        .toolbar .group{display:flex;gap:8px;align-items:center}
        select,button,.btn{border:2px solid var(--line);background:#fff;border-radius:8px;padding:6px 10px;font-size:13px;cursor:pointer}
        .floor-switch button.active{background:var(--hover);font-weight:600}
        .actions{margin-left:auto;display:flex;gap:8px}
        .btn.btn-menu{background:#2563eb;border-color:#2563eb;color:#fff}

        .building{border:2px solid var(--line);background:#fff;border-radius:10px;min-height:420px}
        .wings{display:grid;grid-template-columns:2fr 1.5fr 2fr}
        .wing{border-right:2px solid var(--line);padding:14px}
        .wing:last-child{border-right:none}
        .wing h3{margin:0 0 8px;text-align:center;font-size:14px}
        .rooms{display:grid;grid-template-columns:repeat(2,1fr);gap:6px}
        .room{border:2px dashed #999;border-radius:8px;padding:6px;text-align:center;font-size:12px;cursor:pointer;transition:.15s}

        /* состояния */
        .room.idle   {background:#eee;border-color:#bbb;color:#333} /* пусто */
        .room.ok     {background:var(--free);border-color:var(--free-border)}
        .room.warn   {background:var(--warn);border-color:var(--warn-border)}
        .room.danger {background:var(--danger);border-color:var(--danger-border)}
        .room.over   {background:var(--over);border-color:#000;color:var(--over-text);cursor:pointer} /* фикс синтаксиса + кликабельно */

        .center .room{width:90%;margin:0 auto 10px;font-size:13px}
        .foyer{cursor:default;border-style:solid!important;background:#eee}

        .floor{display:none}.floor.active{display:block}
        .entrance{width:160px;height:80px;margin:6px auto 0;border:2px solid var(--line);border-top:none;border-radius:0 0 80px 80px;background:#eee;display:grid;place-items:center}

        /* Drawer */
        .overlay{position:fixed;inset:0;background:#0006;opacity:0;pointer-events:none;transition:.2s;z-index:20}
        .overlay.open{opacity:1;pointer-events:auto}
        .drawer{position:fixed;top:0;right:0;height:100vh;width:min(460px,92vw);background:#fff;border-left:2px solid var(--line);transform:translateX(100%);transition:.25s;z-index:30;display:flex;flex-direction:column}
        .drawer.open{transform:none}
        .drawer header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:2px solid var(--line)}
        .drawer .content{padding:12px 16px;overflow:auto}
        .kv{display:grid;grid-template-columns:110px 1fr;gap:8px;align-items:center;margin:6px 0}
        .chips{display:flex;flex-wrap:wrap;gap:6px}
        .chip{border:1px solid #bbb;border-radius:999px;padding:4px 8px;background:#fafafa}
        .chip b{font-weight:600}
        .list{display:grid;gap:8px}
        .muted{color:#666}
        .split{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
        .badge{display:inline-block;border:1px solid #bbb;border-radius:6px;padding:2px 6px;background:#fafafa;font-size:12px}
        .danger-btn{border-color:#c1121f;color:#c1121f;background:#fff}
    </style>
</head>
<body>
<div class="wrap">
    <h1>Схема здания с 3 этажами</h1>
    <p class="lead">Выберите слот, затем кликните по аудитории, чтобы назначить группы на это время. Цвет показывает заполненность.</p>

    <div class="toolbar">
        <div class="group floor-switch">
            <strong>Этаж:</strong>
            <button data-floor="1" class="active">1</button>
            <button data-floor="2">2</button>
            <button data-floor="3">3</button>
        </div>
        <div class="group">
            <strong>Слот:</strong>
            <select id="slot-filter"></select>
        </div>
        <div class="group">
            <span class="badge" style="background:#eee;border-color:#bbb">пусто</span>
            <span class="badge" style="background:#e8f8ef;border-color:#6ccf96">≤100%</span>
            <span class="badge" style="background:#fff4cc;border-color:#f2c200">до +25%</span>
            <span class="badge" style="background:#ffe1e1;border-color:#ff6b6b">до +50%</span>
            <span class="badge" style="background:#111;color:#fff;border-color:#000">> +50%</span>
        </div>
        <div class="actions">
            <a class="btn btn-menu" href="/cabinet/me.html">Личный кабинет</a>
            <a class="btn" href="/logout">Выход</a>
        </div>
    </div>

    <div class="building">
        <div class="wings">
            <!-- Левый корпус -->
            <section class="wing">
                <h3>Левый корпус</h3>
                <div class="floor active" data-floor="1">
                    <div class="rooms">
                        <div class="room" data-room="Ауд. 101" data-capacity="30">Ауд. 101 (30)</div>
                        <div class="room" data-room="Ауд. 102" data-capacity="25">Ауд. 102 (25)</div>
                        <div class="room" data-room="Ауд. 103" data-capacity="40">Ауд. 103 (40)</div>
                        <div class="room" data-room="Ауд. 104" data-capacity="28">Ауд. 104 (28)</div>
                        <div class="room" data-room="Ауд. 105" data-capacity="35">Ауд. 105 (35)</div>
                        <div class="room" data-room="Ауд. 106" data-capacity="22">Ауд. 106 (22)</div>
                        <div class="room" data-room="Ауд. 107" data-capacity="32">Ауд. 107 (32)</div>
                        <div class="room" data-room="Ауд. 108" data-capacity="27">Ауд. 108 (27)</div>
                        <div class="room" data-room="Ауд. 109" data-capacity="40">Ауд. 109 (40)</div>
                        <div class="room" data-room="Ауд. 110" data-capacity="36">Ауд. 110 (36)</div>
                    </div>
                </div>
                <div class="floor" data-floor="2">
                    <div class="rooms">
                        <div class="room" data-room="Ауд. 201" data-capacity="34">Ауд. 201 (34)</div>
                        <div class="room" data-room="Ауд. 202" data-capacity="26">Ауд. 202 (26)</div>
                        <div class="room" data-room="Ауд. 203" data-capacity="38">Ауд. 203 (38)</div>
                        <div class="room" data-room="Ауд. 204" data-capacity="25">Ауд. 204 (25)</div>
                        <div class="room" data-room="Ауд. 205" data-capacity="42">Ауд. 205 (42)</div>
                        <div class="room" data-room="Ауд. 206" data-capacity="29">Ауд. 206 (29)</div>
                        <div class="room" data-room="Ауд. 207" data-capacity="31">Ауд. 207 (31)</div>
                        <div class="room" data-room="Ауд. 208" data-capacity="24">Ауд. 208 (24)</div>
                        <div class="room" data-room="Ауд. 209" data-capacity="39">Ауд. 209 (39)</div>
                        <div class="room" data-room="Ауд. 210" data-capacity="30">Ауд. 210 (30)</div>
                    </div>
                </div>
                <div class="floor" data-floor="3">
                    <div class="rooms">
                        <div class="room" data-room="Ауд. 301" data-capacity="28">Ауд. 301 (28)</div>
                        <div class="room" data-room="Ауд. 302" data-capacity="33">Ауд. 302 (33)</div>
                        <div class="room" data-room="Ауд. 303" data-capacity="40">Ауд. 303 (40)</div>
                        <div class="room" data-room="Ауд. 304" data-capacity="23">Ауд. 304 (23)</div>
                        <div class="room" data-room="Ауд. 305" data-capacity="35">Ауд. 305 (35)</div>
                        <div class="room" data-room="Ауд. 306" data-capacity="21">Ауд. 306 (21)</div>
                        <div class="room" data-room="Ауд. 307" data-capacity="27">Ауд. 307 (27)</div>
                        <div class="room" data-room="Ауд. 308" data-capacity="37">Ауд. 308 (37)</div>
                        <div class="room" data-room="Ауд. 309" data-capacity="41">Ауд. 309 (41)</div>
                        <div class="room" data-room="Ауд. 310" data-capacity="30">Ауд. 310 (30)</div>
                    </div>
                </div>
            </section>

            <!-- Центр -->
            <section class="wing center">
                <h3>Центр</h3>
                <div class="floor active" data-floor="1">
                    <div class="room foyer" data-room="Фойе" data-capacity="0">Фойе</div>
                </div>
                <div class="floor" data-floor="2">
                    <div class="room" data-room="Лекционная аудитория" data-capacity="120">Лекционная аудитория (120)</div>
                </div>
                <div class="floor" data-floor="3">
                    <div class="room" data-room="Лекционная аудитория" data-capacity="120">Лекционная аудитория (120)</div>
                </div>
            </section>

            <!-- Правый корпус -->
            <section class="wing">
                <h3>Правый корпус</h3>
                <div class="floor active" data-floor="1">
                    <div class="rooms">
                        <div class="room" data-room="Ауд. 111" data-capacity="28">Ауд. 111 (28)</div>
                        <div class="room" data-room="Ауд. 112" data-capacity="26">Ауд. 112 (26)</div>
                        <div class="room" data-room="Ауд. 113" data-capacity="32">Ауд. 113 (32)</div>
                        <div class="room" data-room="Ауд. 114" data-capacity="24">Ауд. 114 (24)</div>
                        <div class="room" data-room="Ауд. 115" data-capacity="39">Ауд. 115 (39)</div>
                        <div class="room" data-room="Ауд. 116" data-capacity="21">Ауд. 116 (21)</div>
                        <div class="room" data-room="Ауд. 117" data-capacity="33">Ауд. 117 (33)</div>
                        <div class="room" data-room="Ауд. 118" data-capacity="27">Ауд. 118 (27)</div>
                        <div class="room" data-room="Ауд. 119" data-capacity="42">Ауд. 119 (42)</div>
                        <div class="room" data-room="Ауд. 120" data-capacity="34">Ауд. 120 (34)</div>
                    </div>
                </div>
                <div class="floor" data-floor="2">
                    <div class="rooms">
                        <div class="room" data-room="Ауд. 211" data-capacity="29">Ауд. 211 (29)</div>
                        <div class="room" data-room="Ауд. 212" data-capacity="31">Ауд. 212 (31)</div>
                        <div class="room" data-room="Ауд. 213" data-capacity="36">Ауд. 213 (36)</div>
                        <div class="room" data-room="Ауд. 214" data-capacity="24">Ауд. 214 (24)</div>
                        <div class="room" data-room="Ауд. 215" data-capacity="41">Ауд. 215 (41)</div>
                        <div class="room" data-room="Ауд. 216" data-capacity="22">Ауд. 216 (22)</div>
                        <div class="room" data-room="Ауд. 217" data-capacity="34">Ауд. 217 (34)</div>
                        <div class="room" data-room="Ауд. 218" data-capacity="28">Ауд. 218 (28)</div>
                        <div class="room" data-room="Ауд. 219" data-capacity="37">Ауд. 219 (37)</div>
                        <div class="room" data-room="Ауд. 220" data-capacity="30">Ауд. 220 (30)</div>
                    </div>
                </div>
                <div class="floor" data-floor="3">
                    <div class="rooms">
                        <div class="room" data-room="Ауд. 311" data-capacity="25">Ауд. 311 (25)</div>
                        <div class="room" data-room="Ауд. 312" data-capacity="33">Ауд. 312 (33)</div>
                        <div class="room" data-room="Ауд. 313" data-capacity="38">Ауд. 313 (38)</div>
                        <div class="room" data-room="Ауд. 314" data-capacity="23">Ауд. 314 (23)</div>
                        <div class="room" data-room="Ауд. 315" data-capacity="35">Ауд. 315 (35)</div>
                        <div class="room" data-room="Ауд. 316" data-capacity="21">Ауд. 316 (21)</div>
                        <div class="room" data-room="Ауд. 317" data-capacity="30">Ауд. 317 (30)</div>
                        <div class="room" data-room="Ауд. 318" data-capacity="29">Ауд. 318 (29)</div>
                        <div class="room" data-room="Ауд. 319" data-capacity="40">Ауд. 319 (40)</div>
                        <div class="room" data-room="Ауд. 320" data-capacity="32">Ауд. 320 (32)</div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div class="entrance">Вход</div>
</div>

<!-- Drawer -->
<div class="overlay" id="overlay"></div>
<aside class="drawer" id="drawer" aria-hidden="true" role="dialog" aria-labelledby="d-title">
    <header>
        <h2 id="d-title">Бронирование</h2>
        <button id="d-close">Закрыть</button>
    </header>
    <div class="content">
        <div class="kv"><div>Помещение:</div><div><b id="d-room">—</b></div></div>
        <div class="kv"><div>Вместимость:</div><div><span id="d-cap"></span></div></div>
        <div class="kv"><div>Слот:</div><div><span id="d-slot"></span></div></div>

        <hr style="margin:10px 0;border:none;border-top:1px solid #ddd">

        <div class="kv">
            <div>Выбрать группы:</div>
            <div id="groups-box" class="list"></div>
        </div>

        <div class="kv">
            <div>Текущие:</div>
            <div id="current-chips" class="chips muted">—</div>
        </div>

        <div class="kv">
            <div>Загрузка:</div>
            <div id="usage-line" class="muted">0 / 0</div>
        </div>

        <div class="split" style="margin-top:10px">
            <button id="save-book" class="btn">Сохранить бронирование</button>
            <button id="clear-book" class="btn danger-btn">Снять бронирование</button>
        </div>
    </div>
</aside>

<script>
    // ----- слоты -----
    const SLOT_PLAN = [
      ['08:00','09:30'], ['09:40','11:10'], ['11:20','12:50'],
      ['13:20','14:50'], ['15:00','16:30'], ['16:40','18:10'], ['18:20','19:50'],
    ];
    let selectedSlotIndex = 0;

    const slotFilter = document.getElementById('slot-filter');
    SLOT_PLAN.forEach(([s,e],i)=>{ const o=document.createElement('option'); o.value=i; o.textContent=`${s}–${e}`; slotFilter.appendChild(o); });
    slotFilter.value = String(selectedSlotIndex);
    slotFilter.addEventListener('change', ()=>{
      selectedSlotIndex = Number(slotFilter.value);
      recolorAll();
      if(currentRoomEl) openDrawer(currentRoomEl);
    });

    // ----- этажи -----
    document.querySelectorAll('.floor-switch button').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.floor-switch button').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const f=btn.dataset.floor;
        document.querySelectorAll('.floor').forEach(x=>x.classList.toggle('active', x.dataset.floor===f));
      });
    });

    // roomBookings[roomName][slotIndex] = [{id,name,size}]
    const roomBookings = {};

    // ----- группы из API -----
    let ALL_GROUPS = [];
    async function loadGroups(){
      try{
        const res = await fetch('/api/groups', {credentials:'same-origin'});
        const list = await res.json();
        ALL_GROUPS = (Array.isArray(list)?list:[]).map(g=>({
          id:g.id, name:g.name, title:g.title, size:Number(g.size ?? g.students ?? g.count ?? 0)
        }));
      }catch{
        ALL_GROUPS = [
          {id:1,name:'ИС-101',size:24},
          {id:2,name:'ИС-102',size:26},
          {id:3,name:'ПМИ-11',size:32},
          {id:4,name:'Дизайн-21',size:18},
        ];
      }
    }

    // ----- утилиты -----
    function sumSize(groups){ return groups.reduce((a,g)=>a + (Number(g.size)||0), 0); }
    function statusBy(capacity, used){
      if (used <= 0) return 'idle';     // пусто — серый
      if (capacity <= 0) return 'ok';   // без лимита
      const ratio = used / capacity;
      if (ratio <= 1)    return 'ok';
      if (ratio <= 1.25) return 'warn';
      if (ratio <= 1.50) return 'danger';
      return 'over';                    // > +50% — чёрный (но кликабельный)
    }
    function recolorAll(){
      document.querySelectorAll('.room').forEach(el=>{
        if (el.classList.contains('foyer')) return;
        const cap = Number(el.dataset.capacity||0);
        const name = el.dataset.room;
        const groups = (roomBookings[name]?.[selectedSlotIndex]) || [];
        const used = sumSize(groups);
        const st = statusBy(cap, used);
        el.classList.remove('idle','ok','warn','danger','over');
        el.classList.add(st);
        el.title = `${name}\nВместимость: ${cap}\nНазначено: ${used}`;
      });
    }

    // ----- Drawer -----
    const overlay   = document.getElementById('overlay');
    const drawer    = document.getElementById('drawer');
    const dClose    = document.getElementById('d-close');
    const dRoom     = document.getElementById('d-room');
    const dCap      = document.getElementById('d-cap');
    const dSlot     = document.getElementById('d-slot');
    const groupsBox = document.getElementById('groups-box');
    const chips     = document.getElementById('current-chips');
    const usageLine = document.getElementById('usage-line');
    const saveBtn   = document.getElementById('save-book');
    const clearBtn  = document.getElementById('clear-book');

    let currentRoomEl = null;

    function renderGroupsSelector(selected){
      groupsBox.innerHTML = '';
      const selIds = new Set(selected.map(g=>g.id));
      ALL_GROUPS.forEach(g=>{
        const row = document.createElement('label');
        row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px';
        row.innerHTML = `<input type="checkbox" value="${g.id}" ${selIds.has(g.id)?'checked':''}>
                         <span>${g.name}${g.title?` — ${g.title}`:''}</span>
                         <span class="muted">(${g.size})</span>`;
        groupsBox.appendChild(row);
      });
    }
    function renderCurrentChips(selected){
      chips.innerHTML = selected.length ? '' : '—';
      selected.forEach(g=>{
        const div = document.createElement('div');
        div.className='chip';
        div.innerHTML = `<b>${g.name}</b> <span class="muted">(${g.size})</span>
                         <button data-x="${g.id}" style="margin-left:6px;border:none;background:transparent;cursor:pointer">✕</button>`;
        chips.appendChild(div);
      });
    }
    function calcAndPaintUsage(cap, selected){
      const used = sumSize(selected);
      const st = statusBy(cap, used);
      usageLine.textContent = `${used} / ${cap}`;
      usageLine.className = '';
      if (st !== 'over') usageLine.classList.add(st);
    }

    function openDrawer(el){
      if (!el || el.classList.contains('foyer')) return; // только фойе запрещаем

      currentRoomEl = el;
      const name = el.dataset.room;
      const cap  = Number(el.dataset.capacity||0);
      const slotLabel = SLOT_PLAN[selectedSlotIndex].join('–');

      dRoom.textContent = name;
      dCap.textContent  = cap;
      dSlot.textContent = slotLabel;

      const selected = (roomBookings[name]?.[selectedSlotIndex]) ? [...roomBookings[name][selectedSlotIndex]] : [];
      renderGroupsSelector(selected);
      renderCurrentChips(selected);
      calcAndPaintUsage(cap, selected);

      overlay.classList.add('open');
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden','false');

      // снять по крестику
      chips.onclick = (e)=>{
        const id = Number(e.target?.dataset?.x);
        if (!id) return;
        groupsBox.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
          if (Number(cb.value)===id) cb.checked = false;
        });
        const newSel = getSelectedFromBoxes();
        renderCurrentChips(newSel);
        calcAndPaintUsage(cap, newSel);
      };
      // чекбоксы
      groupsBox.onchange = ()=>{
        const newSel = getSelectedFromBoxes();
        renderCurrentChips(newSel);
        calcAndPaintUsage(cap, newSel);
      };
      // сохранить
      saveBtn.onclick = ()=>{
        const sel = getSelectedFromBoxes();
        if (!roomBookings[name]) roomBookings[name] = {};
        roomBookings[name][selectedSlotIndex] = sel;
        // TODO: POST /api/bookings
        recolorAll();
        closeDrawer();
      };
      // очистить
      clearBtn.onclick = ()=>{
        if (roomBookings[name]) delete roomBookings[name][selectedSlotIndex];
        // TODO: DELETE /api/bookings
        recolorAll();
        closeDrawer();
      };
    }
    function closeDrawer(){
      overlay.classList.remove('open');
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden','true');
      currentRoomEl=null;
    }
    function getSelectedFromBoxes(){
      const checked = [...groupsBox.querySelectorAll('input[type="checkbox"]:checked')].map(cb=>Number(cb.value));
      const map = new Map(ALL_GROUPS.map(g=>[g.id,g]));
      return checked.map(id=>map.get(id)).filter(Boolean);
    }
    overlay.addEventListener('click', closeDrawer);
    dClose.addEventListener('click', closeDrawer);

    // клики по аудиториям
    document.querySelectorAll('.room').forEach(el=>{
      if (el.classList.contains('foyer')) return;
      el.addEventListener('click', ()=>openDrawer(el));
    });

    // init
    (async function init(){
      await loadGroups();
      recolorAll(); // стартовые цвета
    })();
</script>
</body>
</html>
